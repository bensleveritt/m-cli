#!/usr/bin/env bash

declare command="$(basename "$0")"
declare subcommand="$1"

[ $# -gt 0 ] && shift

help(){
    cat<<__EOF__
    usage:  m network [ ls | list | location | help ]

    Examples:
      m network ls                          # list network interfaces
      m network location                    # get current location
      m network location ls                 # list locations
      m network location create XYZ         # create a location
      m network location delete XYZ         # delete a location
      m network location switch XYZ         # switch location
      m network defaultusername "your name" # the default username when connecting (don't specify a name to disable)
__EOF__

}

list_netservices(){
    networksetup -listallhardwareports | while IFS= read -r line; do
        # if it is a device we will print the ip in the next line
        if echo ${line} | grep -i "Device" >/dev/null 2>&1; then
            printf "${line}\nIP:$(ipconfig getifaddr $(echo ${line} | cut -d: -f2 2>/dev/null))\n"

        else
            printf "${line}\n"
        fi
    done
}

defaultusername(){
    local username="$1"

    if [ -n "$1" ]; then
        defaults write com.apple.NetworkAuthorization UseDefaultName -bool true
        defaults write com.apple.NetworkAuthorization DefaultName "${username}"
    else
        defaults delete com.apple.NetworkAuthorization UseDefaultName
        defaults delete com.apple.NetworkAuthorization DefaultName
    fi
}


location(){
    case $1 in
        create)
            [ -z "$2" ] && help && exit 1;
            networksetup -createlocation $2
            ;;
        delete|rm)
            [ -z "$2" ] && help && exit 1;
            networksetup -deletelocation $2
            ;;
        switch)
            [ -z "$2" ] && help && exit 1;
            networksetup -switchtolocation $2
            ;;
        list|ls)
            echo "Locations: "
            networksetup -listlocations
            ;;
        *)
            echo "Current location: $(networksetup -getcurrentlocation)"
            ;;
    esac
}

case "${subcommand}" in
    help)
        help
        ;;
    ls|list)
        list_netservices
        ;;
    location)
        location $@
        ;;
    defaultusername)
        defaultusername $@
        ;;
    *)
        help
        ;;
esac

# vim: ts=4 sw=4 softtabstop=4 expandtab
